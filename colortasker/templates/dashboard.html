<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <meta charset="UTF-8">
    <title>Dashboard - Color Tasker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
        }
        .close-button {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        /* Sidebar and dashboard styling */
        body {
            display: flex;
            font-family: Arial, sans-serif;
        }
        .sidebar {
            width: 250px;
            background-color: #f4f4f4;
            padding: 20px;
            height: 100vh;
        }
        .content {
            flex: 1;
            padding: 20px;
        }
        .folder-list {
            list-style: none;
            padding: 0;
        }
        .folder-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .folder-link {
            text-decoration: none;
            color: #333;
            display: flex;
            align-items: center;
        }
        .folder-link:hover {
            color: #007bff;
        }
        .edit-folder-button {
            background-color: transparent;
            border: none;
            color: #007bff;
            cursor: pointer;
        }
        .task-block {
            display: inline-block;
            width: 150px;
            height: 150px;
            margin: 10px;
            padding: 10px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
        }
        .collaborators {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .collaborator {
            text-align: center;
        }
        .collaborator img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        .add-button {
            background-color: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 30px;
            cursor: pointer;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        .dropdown {
            position: absolute;
            display: none;
            top: 60px;
            left: 20px;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            z-index: 1100;
        }
        .dropdown button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            padding: 5px;
        }
    </style>
    {% endblock %}
</head>
<body>
    <div class="sidebar">
        <h2>Folders</h2>
        <ul class="folder-list">
            {% for folder in folders %}
                <li>
                    <a href="#" class="folder-link" data-folder-id="{{ folder.id }}">{{ folder.name }}</a>
                    <button class="edit-folder-button" onclick="editFolder('{{ folder.id }}', '{{ folder.name }}')">Edit</button>
                </li>
            {% else %}
                <li>You have no folders.</li>
            {% endfor %}
        </ul>
        <button id="calendar-button" class="icon-button">
        <img src="{{ url_for('static', filename='images/calendar_icon.png') }}" alt="Calendar" class="icon-image">
    </button>
    </div>
    <div class="content">
        <h1>ColorTasker</h1>
        {% if collaborators %}
        <div class="collaborators">
            {% for collaborator in collaborators %}
                <div class="collaborator">
                    <img src="{{ collaborator.avatar }}" alt="{{ collaborator.name }}">
                    <p>{{ collaborator.name }}</p>
                </div>
            {% endfor %}
        </div>
        {% endif %}
        <h2 id="folder-title">Tasks</h2>
        <div id="task-container">
            <!-- Task blocks will be populated here -->
        </div>
    </div>
    <button class="add-button" id="add-button">+</button>
    <div class="dropdown" id="add-dropdown">
        <button id="add-new-task">Add New Task</button>
        <button id="add-new-folder">Add New Folder</button>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-task-modal">&times;</span>
            <h2 id="task-modal-title">Create/Edit Task</h2>
            <form id="task-form">
                <input type="hidden" name="task_id" id="task-id">
                <!-- Folder Selection -->
                <label for="task-folder-id">Select Folder:</label>
                <select name="folder_id" id="task-folder-id" required>
                    <!-- Options will be populated dynamically -->
                </select>

                <label for="task-name">Task Name:</label>
                <input type="text" name="task_name" id="task-name" required>

                <label for="task-deadline">Deadline:</label>
                <input type="date" name="deadline" id="task-deadline">

                <label for="task-description">Description:</label>
                <textarea name="description" id="task-description"></textarea>

                <label for="task-color">Color:</label>
                <input type="color" name="color" id="task-color" value="#ffffff">

                <button type="submit">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-confirm-modal">&times;</span>
            <p id="confirm-message"></p>
            <button id="confirm-yes-button">Yes</button>
            <button id="confirm-no-button">No</button>
        </div>
    </div>

    {% block scripts %}
    <script>

        // Add event listener to calendar button
        document.getElementById('calendar-button').onclick = function() {
            window.location.href = "{{ url_for('main.calendar_view') }}";
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const taskModal = document.getElementById('task-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const addDropdown = document.getElementById('add-dropdown');
            const addButton = document.getElementById('add-button');
            const folderTitle = document.getElementById('folder-title');
            const taskContainer = document.getElementById('task-container');
            const taskForm = document.getElementById('task-form');

            let currentFolderId = null;
            let currentTaskId = null;
            let actionType = ''; // 'delete' or 'complete'

            // Toggle Add Dropdown
            addButton.onclick = function() {
                addDropdown.style.display = addDropdown.style.display === 'block' ? 'none' : 'block';
            };

            // Add New Folder
            document.getElementById('add-new-folder').onclick = function() {
                const folderName = prompt('Enter folder name:');
                if (folderName) {
                    fetch('{{ url_for('main.create_folder') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ folder_name: folderName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Add new folder to the list
                        const folderList = document.querySelector('.folder-list');
                        const newFolderItem = document.createElement('li');
                        const newFolderLink = document.createElement('a');
                        newFolderLink.href = '#';
                        newFolderLink.classList.add('folder-link');
                        newFolderLink.dataset.folderId = data.folder_id;
                        newFolderLink.textContent = data.folder_name;
                        newFolderLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            currentFolderId = this.dataset.folderId;
                            openFolder(currentFolderId);
                        });
                        const editButton = document.createElement('button');
                        editButton.classList.add('edit-folder-button');
                        editButton.textContent = 'Edit';
                        editButton.onclick = function() {
                            editFolder(data.folder_id, data.folder_name);
                        };
                        newFolderItem.appendChild(newFolderLink);
                        newFolderItem.appendChild(editButton);
                        folderList.appendChild(newFolderItem);
                    })
                    .catch(error => console.error('Error:', error));
                }
                addDropdown.style.display = 'none';
            };

            // Add New Task
            document.getElementById('add-new-task').onclick = function() {
                openTaskModal(null);
                addDropdown.style.display = 'none';
            };

            // Open Folder and Fetch Tasks
            function openFolder(folderId) {
                currentFolderId = folderId;
                fetch(`{{ url_for('main.get_folder_content') }}?folder_id=${folderId}`)
                .then(response => response.json())
                .then(data => {
                    folderTitle.textContent = data.folder_name;
                    taskContainer.innerHTML = '';
                    data.tasks.forEach(task => {
                        const taskBlock = document.createElement('div');
                        taskBlock.classList.add('task-block');
                        if (task.is_complete) {
                            taskBlock.classList.add('task-complete');
                        }
                        taskBlock.style.backgroundColor = task.color || '#ffffff';

                        const taskName = document.createElement('div');
                        taskName.classList.add('task-name');
                        taskName.textContent = task.name;

                        const taskDescription = document.createElement('div');
                        taskDescription.classList.add('task-description');
                        taskDescription.textContent = task.description || '';

                        // Buttons container
                        const taskButtons = document.createElement('div');
                        taskButtons.classList.add('task-buttons');

                        // Delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('task-delete-button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.onclick = function(e) {
                            e.stopPropagation();
                            confirmAction('delete', task.id);
                        };

                        // Complete button (only if task is not complete)
                        if (!task.is_complete) {
                            const completeButton = document.createElement('button');
                            completeButton.classList.add('task-complete-button');
                            completeButton.textContent = 'Complete';
                            completeButton.onclick = function(e) {
                                e.stopPropagation();
                                confirmAction('complete', task.id);
                            };
                            taskButtons.appendChild(completeButton);
                        }

                        taskButtons.appendChild(deleteButton);

                        // Append elements to task block
                        taskBlock.appendChild(taskName);
                        taskBlock.appendChild(taskDescription);
                        taskBlock.appendChild(taskButtons);

                        // Hover effects for description
                        taskBlock.addEventListener('mouseover', function() {
                            taskDescription.style.display = 'block';
                            taskButtons.style.display = 'flex';
                        });
                        taskBlock.addEventListener('mouseout', function() {
                            taskDescription.style.display = 'none';
                            taskButtons.style.display = 'none';
                        });

                        taskBlock.onclick = function() {
                            openTaskModal(task.id);
                        };

                        taskContainer.appendChild(taskBlock);
                    });
                })
                .catch(error => console.error('Error:', error));
            }




            // Attach click event to folder links
            document.querySelectorAll('.folder-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const folderId = this.dataset.folderId;
                    openFolder(folderId);
                });
            });

            // Edit Folder Name
            window.editFolder = function(folderId, currentName) {
                const newName = prompt('Edit folder name:', currentName);
                if (newName && newName !== currentName) {
                    fetch('{{ url_for('main.edit_folder') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ folder_id: folderId, folder_name: newName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.querySelector(`.folder-link[data-folder-id='${folderId}']`).textContent = newName;
                    })
                    .catch(error => console.error('Error:', error));
                }
            };

            // Open Task Modal for Create/Edit
            function openTaskModal(taskId) {
                currentTaskId = taskId;

                // Fetch user's folders and populate the dropdown
                fetch('{{ url_for('main.get_user_folders') }}')
                .then(response => response.json())
                .then(data => {
                    const folderSelect = document.getElementById('task-folder-id');
                    folderSelect.innerHTML = ''; // Clear existing options
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        folderSelect.appendChild(option);
                    });

                    if (currentFolderId) {
                        folderSelect.value = currentFolderId;
                    }

                    if (taskId) {
                        // Fetch task data and populate form
                        fetch(`{{ url_for('main.get_task') }}?task_id=${taskId}`)
                        .then(response => response.json())
                        .then(taskData => {
                            document.getElementById('task-id').value = taskData.task_id;
                            document.getElementById('task-name').value = taskData.task_name;
                            document.getElementById('task-deadline').value = taskData.deadline;
                            document.getElementById('task-description').value = taskData.description;
                            document.getElementById('task-color').value = taskData.color;
                            // Set the selected folder
                            folderSelect.value = taskData.folder_id;
                        })
                        .catch(error => console.error('Error:', error));
                    } else {
                        // Clear form for new task
                        taskForm.reset();
                    }
                    taskModal.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
            }

            // Close Modals
            document.getElementById('close-task-modal').onclick = function() {
                taskModal.style.display = 'none';
            };

            document.getElementById('close-confirm-modal').onclick = function() {
                confirmModal.style.display = 'none';
            };

            // Handle Task Form Submission
            taskForm.onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(taskForm);
                const url = currentTaskId ? '{{ url_for('main.edit_task') }}' : '{{ url_for('main.create_task') }}';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    taskModal.style.display = 'none';
                    // Refresh the task list
                    if (currentFolderId) {
                        openFolder(currentFolderId);
                    }
                })
                .catch(error => console.error('Error:', error));
            };

            // Confirm Delete or Complete Action
            function confirmAction(type, taskId) {
                actionType = type;
                currentTaskId = taskId;
                const message = type === 'delete' ? 'Are you sure you want to delete this task?' : 'Mark this task as complete?';
                document.getElementById('confirm-message').textContent = message;
                confirmModal.style.display = 'block';
            }

            // Handle Confirmation
            document.getElementById('confirm-yes-button').onclick = function() {
                const url = actionType === 'delete' ? '{{ url_for('main.delete_task') }}' : '{{ url_for('main.mark_complete') }}';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ task_id: currentTaskId })
                })
                .then(response => response.json())
                .then(data => {
                    confirmModal.style.display = 'none';
                    // Refresh the task list
                    if (currentFolderId) {
                        openFolder(currentFolderId);
                    }
                })
                .catch(error => console.error('Error:', error));
            };


            // Handle Confirmation
            document.getElementById('confirm-yes-button').onclick = function() {
                const url = actionType === 'delete' ? '{{ url_for('main.delete_task') }}' : '{{ url_for('main.mark_complete') }}';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ task_id: currentTaskId })
                })
                .then(response => response.json())
                .then(data => {
                    confirmModal.style.display = 'none';
                    // Refresh the task list
                    if (currentFolderId) {
                        openFolder(currentFolderId);
                    }
                })
                .catch(error => console.error('Error:', error));
            };

            document.getElementById('confirm-no-button').onclick = function() {
                confirmModal.style.display = 'none';
            };
        });
    </script>
    {% endblock %}
</body>
</html>
