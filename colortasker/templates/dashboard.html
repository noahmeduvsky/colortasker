<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <meta charset="UTF-8">
    <title>Dashboard - Color Tasker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 10px;
            position: relative;
        }
        .close-button {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
        }
        .close-button:hover {
            color: #e74c3c;
        }
        .home-button-container {
            position: absolute;
            top: 10px; /* Adjust the spacing from the top */
            left: 10px; /* Adjust the spacing from the left */
            z-index: 1000; /* Ensure it appears above other elements */
        }

        .home-button-container .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .home-button-container .icon-image {
            width: 30px; /* Adjust size as needed */
            height: 30px;
        }
        /* Sidebar and dashboard styling */
        body {
            margin: 0;
            display: flex;
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .sidebar {
            width: 250px;
            background-color: #34495e;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            position: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content {
            flex: 1;
            padding: 40px;
            margin-left: 250px;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .folder-list {
            list-style: none;
            padding: 0;
            margin-top: 30px;
        }
        .folder-list li {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .folder-link {
            text-decoration: none;
            color: #ecf0f1;
            font-size: 18px;
            display: flex;
            align-items: center;
            transition: color 0.3s;
        }
        .folder-link:hover {
            color: #e74c3c;
        }
        .edit-folder-button {
            background-color: transparent;
            border: none;
            color: #ecf0f1;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s;
        }
        .edit-folder-button:hover {
            color: #e74c3c;
        }
        .task-block {
            width: 150px;
            height: 150px;
            margin: 10px;
            padding: 10px;
            color: #fff;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .task-block:hover {
            transform: translateY(-5px);
        }
        .task-block .task-name {
            font-size: 18px;
        }
        .task-block .task-description {
            display: none;
            font-style: italic;
            font-size: 14px;
            margin-top: 5px;
            color: #ecf0f1;
        }
        .task-block:hover .task-description {
            display: block;
        }
        .task-buttons {
            position: absolute;
            bottom: 10px;
            display: none;
            gap: 5px;
        }
        .task-buttons button {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .task-delete-button {
            background-color: #e74c3c;
            color: #fff;
        }
        .task-complete-button {
            background-color: #27ae60;
            color: #fff;
        }
        .task-delete-button:hover {
            background-color: #c0392b;
        }
        .task-complete-button:hover {
            background-color: #229954;
        }
        .task-block:hover .task-buttons {
            display: flex;
        }
        .task-complete {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .add-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 36px;
            cursor: pointer;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 900;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.2s;
        }
        .add-button:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        .dropdown {
            position: absolute;
            display: none;
            bottom: 80px;
            right: 20px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
            z-index: 950;
        }
        .dropdown button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .dropdown button:hover {
            background-color: #2980b9;
        }
        .icon-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        .icon-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .icon-image {
            width: 30px;
            height: 30px;
        }
        /* Logout Button */
        .logout-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #e74c3c;
            color: white;
            text-decoration: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 800;
        }
        /* Add Friends Button */
        .add-friends-button {
            background-color: #1abc9c;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
            width: 100%;
        }
        .add-friends-button:hover {
            background-color: #16a085;
        }
        /* Friends Section */
        .friends-section {
            margin-top: 30px;
            width: 100%;
            text-align: center;
        }
        .friends-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            color: #ecf0f1;
        }
        .friends-list li {
            margin-bottom: 10px;
        }

        .calendar-button-container {
            position: absolute;
            top: 60px; 
            left: 10px;
            z-index: 999;
        }

        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .icon-image {
            width: 30px; 
            height: 30px;
        }
    </style>
    {% endblock %}
</head>
<body>
    <!-- Logout Button -->
    <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>

    <!-- Home Button -->
    <div class="home-button-container">
        <button id="home-button" class="icon-button">
            <img src="{{ url_for('static', filename='images/dashboard_icon.png') }}" alt="Home" class="icon-image">
        </button>
    </div>

    <div class="sidebar">
        <div class="calendar-button-container">
            <button id="calendar-button" class="icon-button">
                <img src="{{ url_for('static', filename='images/calendar_icon.png') }}" alt="Calendar" class="icon-image">
            </button>
        </div>
        <div>
            <h2>Folders</h2>
            <ul class="folder-list">
                {% for folder in folders %}
                    <li>
                        <a href="#" class="folder-link" data-folder-id="{{ folder.id }}">{{ folder.name }}</a>
                        <button class="edit-folder-button" onclick="editFolder({{ folder.id }}, '{{ folder.name|e }}')">Edit</button>
                        <button class="delete-folder-button" onclick="deleteFolder({{ folder.id }})">Delete</button>
                    </li>
                {% else %}
                    <li>You have no folders.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Friends Section -->
        <div class="friends-section">
            <h2>Your Friends</h2>
            <ul class="friends-list">
                {% for friend in friends %}
                    <li>{{ friend.name }}</li>
                {% else %}
                    <li>You have no friends yet.</li>
                {% endfor %}
            </ul>
            <button id="add-friends-btn" class="add-friends-button">Add Friends</button>
        </div>
    </div>

    <div class="content">
        <h1>ColorTasker</h1>
        {% if collaborators %}
        <div class="collaborators">
            {% for collaborator in collaborators %}
                <div class="collaborator">
                    <img src="{{ collaborator.avatar }}" alt="{{ collaborator.name }}">
                    <p>{{ collaborator.name }}</p>
                </div>
            {% endfor %}
        </div>
        {% endif %}
        <h2 id="folder-title">Tasks</h2>
        <div id="task-container">
            <!-- Task blocks will be populated here -->
        </div>
    </div>

    <button class="add-button" id="add-button">+</button>
    <div class="dropdown" id="add-dropdown">
        <button id="add-new-task">Add New Task</button>
        <button id="add-new-folder">Add New Folder</button>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-task-modal">&times;</span>
            <h2 id="task-modal-title">Create/Edit Task</h2>
            <form id="task-form">
                <input type="hidden" name="task_id" id="task-id">
                <!-- Folder Selection -->
                <label for="task-folder-id">Select Folder:</label>
                <select name="folder_id" id="task-folder-id" required>
                    <!-- Options will be populated dynamically -->
                </select>

                <label for="task-name">Task Name:</label>
                <input type="text" name="task_name" id="task-name" required>

                <label for="task-deadline">Deadline:</label>
                <input type="date" name="deadline" id="task-deadline">

                <label for="task-description">Description:</label>
                <textarea name="description" id="task-description"></textarea>

                <label for="task-color">Color:</label>
                <input type="color" name="color" id="task-color" value="#3498db">

                <button type="submit">Save Task</button>
            </form>
            <!-- Collaborators Section -->
            <div id="collaborators-section">
                <h3>Collaborators</h3>
                <ul id="collaborators-list">
                <!-- List of collaborators will be populated here -->
                </ul>
                <input type="email" id="invite-email" placeholder="Invite user by email">
                <button id="invite-button">Invite</button>

                <!-- New Friends Section -->
                <h3>Invite from Friends</h3>
                <ul id="friends-list">
                <!-- Friends list will be dynamically populated here -->
                </ul>
            </div>
            <!-- Comments Section -->
            <div id="comments-section">
                <h3>Comments</h3>
                <div id="comments-container">
                    <!-- Comments will be loaded here -->
                </div>
                <textarea id="comment-content" placeholder="Add a comment..."></textarea>
                <button id="add-comment-button">Add Comment</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-confirm-modal">&times;</span>
            <p id="confirm-message"></p>
            <button id="confirm-yes-button">Yes</button>
            <button id="confirm-no-button">No</button>
        </div>
    </div>

    <!-- Add Friends Modal -->
    <div id="add-friends-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-button">&times;</span>
            <h2>Add Friends</h2>
            <input type="text" id="friend-search" placeholder="Search for users..." autocomplete="off" />
            <ul id="search-results"></ul>
        </div>
    </div>

    {% block scripts %}
    <script>
        function deleteFolder(folderId) {
                const folderToDelete = folderId || currentFolderId; // Use currentFolderId if no folderId is passed

                if (!folderToDelete) {
                    alert('No folder selected for deletion!');
                    return;
                }

                if (confirm('Are you sure you want to delete this folder? This will also delete all tasks inside the folder.')) {
                    console.log(`Attempting to delete folder with ID: ${folderToDelete}`);
                    fetch('/delete_folder', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ folder_id: folderToDelete })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(data.message);
                            location.reload(); // Refresh the page to update the folder list
                        } else if (data.error) {
                            alert(data.error);
                        }
                    })
                    .catch(error => console.error('Error deleting folder:', error));
                }
            }

        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const taskModal = document.getElementById('task-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const addDropdown = document.getElementById('add-dropdown');
            const addButton = document.getElementById('add-button');
            const folderTitle = document.getElementById('folder-title');
            const taskContainer = document.getElementById('task-container');
            const taskForm = document.getElementById('task-form');
            const deleteButtons = document.querySelectorAll('.delete-folder-button');

            let currentFolderId = null;
            let currentTaskId = null;
            let actionType = ''; // 'delete' or 'complete'

            // Redirect to the dashboard on home button click
            document.getElementById('home-button').onclick = function () {
                window.location.href = "{{ url_for('main.dashboard') }}";
            };

            // Fetch all tasks for the user
            fetch('/get_all_user_tasks')
                .then(response => response.json())
                .then(data => {
                    taskContainer.innerHTML = ''; // Clear any existing tasks

                    if (data.tasks.length === 0) {
                        const emptyMessage = document.createElement('p');
                        emptyMessage.textContent = 'No tasks available.';
                        taskContainer.appendChild(emptyMessage);
                        return;
                    }

                    data.tasks.forEach(task => {
                        const taskBlock = document.createElement('div');
                        taskBlock.classList.add('task-block');
                        if (task.is_complete) {
                            taskBlock.classList.add('task-complete');
                        }
                        taskBlock.style.backgroundColor = task.color || '#3498db';

                        const taskName = document.createElement('div');
                        taskName.classList.add('task-name');
                        taskName.textContent = task.name;

                        const taskDescription = document.createElement('div');
                        taskDescription.classList.add('task-description');
                        taskDescription.textContent = task.description || '';

                        // Buttons container
                        const taskButtons = document.createElement('div');
                        taskButtons.classList.add('task-buttons');

                        // Delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('task-delete-button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.onclick = function (e) {
                            e.stopPropagation();
                            fetch('{{ url_for('main.delete_task') }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                },
                                body: JSON.stringify({ task_id: task.id })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.message) {
                                        alert(data.message);
                                        reloadTasks(); // Refresh tasks dynamically
                                    } else if (data.error) {
                                        alert(data.error);
                                    }
                                })
                                .catch(error => console.error('Error deleting task:', error));
                        };

                        //Complete button
                        if (!task.is_complete) {
                            const completeButton = document.createElement('button');
                            completeButton.classList.add('task-complete-button');
                            completeButton.textContent = 'Complete';
                            completeButton.onclick = function (e) {
                                e.stopPropagation();
                                fetch('{{ url_for('main.mark_complete') }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                    },
                                    body: JSON.stringify({ task_id: task.id })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.message) {
                                            alert(data.message);
                                            reloadTasks(); // Refresh tasks dynamically
                                        } else if (data.error) {
                                            alert(data.error);
                                        }
                                    })
                                    .catch(error => console.error('Error marking task as complete:', error));
                            };
                            taskButtons.appendChild(completeButton);
                        }

                        taskButtons.appendChild(deleteButton);

                        // Append elements to task block
                        taskBlock.appendChild(taskName);
                        taskBlock.appendChild(taskDescription);
                        taskBlock.appendChild(taskButtons);

                        // Hover effects for description and buttons
                        taskBlock.addEventListener('mouseover', function () {
                            taskDescription.style.display = 'block';
                            taskButtons.style.display = 'flex';
                        });
                        taskBlock.addEventListener('mouseout', function () {
                            taskDescription.style.display = 'none';
                            taskButtons.style.display = 'none';
                        });

                        taskBlock.onclick = function () {
                            openTaskModal(task.id);
                        };

                        taskContainer.appendChild(taskBlock);
                    });
                })
                .catch(error => console.error('Error fetching tasks:', error));

                function reloadTasks() {
                    fetch('/get_all_user_tasks')
                    .then(response => response.json())
                    .then(data => {
                        taskContainer.innerHTML = ''; // Clear existing tasks

                        if (data.tasks.length === 0) {
                            const emptyMessage = document.createElement('p');
                            emptyMessage.textContent = 'No tasks available.';
                            taskContainer.appendChild(emptyMessage);
                            return;
                        }

                        data.tasks.forEach(task => {
                            const taskBlock = document.createElement('div');
                            taskBlock.classList.add('task-block');
                            if (task.is_complete) {
                                taskBlock.classList.add('task-complete');
                            }
                            taskBlock.style.backgroundColor = task.color || '#3498db';

                            const taskName = document.createElement('div');
                            taskName.classList.add('task-name');
                            taskName.textContent = task.name;

                            const taskDescription = document.createElement('div');
                            taskDescription.classList.add('task-description');
                            taskDescription.textContent = task.description || '';

                            // Buttons container
                            const taskButtons = document.createElement('div');
                            taskButtons.classList.add('task-buttons');

                            // Add updated delete button
                            const deleteButton = document.createElement('button');
                            deleteButton.classList.add('task-delete-button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = function (e) {
                                e.stopPropagation();
                                fetch('{{ url_for('main.delete_task') }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                    },
                                    body: JSON.stringify({ task_id: task.id })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.message) {
                                            alert(data.message);
                                            reloadTasks(); // Refresh tasks dynamically
                                        } else if (data.error) {
                                            alert(data.error);
                                        }
                                    })
                                    .catch(error => console.error('Error deleting task:', error));
                            };
                            taskButtons.appendChild(deleteButton);

                            // Add updated complete button
                            if (!task.is_complete) {
                                const completeButton = document.createElement('button');
                                completeButton.classList.add('task-complete-button');
                                completeButton.textContent = 'Complete';
                                completeButton.onclick = function (e) {
                                    e.stopPropagation();
                                    fetch('{{ url_for('main.mark_complete') }}', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': '{{ csrf_token() }}'
                                        },
                                        body: JSON.stringify({ task_id: task.id })
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.message) {
                                                alert(data.message);
                                                reloadTasks(); // Refresh tasks dynamically
                                            } else if (data.error) {
                                                alert(data.error);
                                            }
                                        })
                                        .catch(error => console.error('Error marking task as complete:', error));
                                };
                                taskButtons.appendChild(completeButton);
                            }

                            taskBlock.appendChild(taskName);
                            taskBlock.appendChild(taskDescription);
                            taskBlock.appendChild(taskButtons);

                            taskContainer.appendChild(taskBlock);
                        });
                    })
                    .catch(error => console.error('Error reloading tasks:', error));
            }

            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const folderId = button.getAttribute('data-folder-id');
                    console.log(`Delete button clicked for folder ID: ${folderId}`);
                    deleteFolder(folderId);
                });
            });

            // Calendar Button
            document.getElementById('calendar-button').onclick = function() {
                window.location.href = "{{ url_for('main.calendar_view') }}";
            };

            // Toggle Add Dropdown
            addButton.onclick = function() {
                addDropdown.style.display = addDropdown.style.display === 'block' ? 'none' : 'block';
            };

            // Add New Folder
            document.getElementById('add-new-folder').onclick = function() {
                const folderName = prompt('Enter folder name:');
                if (folderName) {
                    fetch('{{ url_for('main.create_folder') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ folder_name: folderName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Add new folder to the list
                        const folderList = document.querySelector('.folder-list');
                        const newFolderItem = document.createElement('li');
                        const newFolderLink = document.createElement('a');
                        newFolderLink.href = '#';
                        newFolderLink.classList.add('folder-link');
                        newFolderLink.dataset.folderId = data.folder_id;
                        newFolderLink.textContent = data.folder_name;
                        newFolderLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            currentFolderId = this.dataset.folderId;
                            openFolder(currentFolderId);
                        });
                        const editButton = document.createElement('button');
                        editButton.classList.add('edit-folder-button');
                        editButton.textContent = 'Edit';
                        editButton.onclick = function() {
                            editFolder(data.folder_id, data.folder_name);
                        };
                        newFolderItem.appendChild(newFolderLink);
                        newFolderItem.appendChild(editButton);
                        folderList.appendChild(newFolderItem);
                    })
                    .catch(error => console.error('Error:', error));
                }
                addDropdown.style.display = 'none';
            };

            // Add New Task
            document.getElementById('add-new-task').onclick = function() {
                openTaskModal(null);
                addDropdown.style.display = 'none';
            };

            // Open Folder and Fetch Tasks
            function openFolder(folderId) {
                currentFolderId = folderId;
                fetch(`{{ url_for('main.get_folder_content') }}?folder_id=${folderId}`)
                .then(response => response.json())
                .then(data => {
                    folderTitle.textContent = data.folder_name;
                    taskContainer.innerHTML = '';
                    data.tasks.forEach(task => {
                        const taskBlock = document.createElement('div');
                        taskBlock.classList.add('task-block');
                        if (task.is_complete) {
                            taskBlock.classList.add('task-complete');
                        }
                        taskBlock.style.backgroundColor = task.color || '#3498db';

                        const taskName = document.createElement('div');
                        taskName.classList.add('task-name');
                        taskName.textContent = task.name;

                        const taskDescription = document.createElement('div');
                        taskDescription.classList.add('task-description');
                        taskDescription.textContent = task.description || '';

                        // Buttons container
                        const taskButtons = document.createElement('div');
                        taskButtons.classList.add('task-buttons');

                        // Delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('task-delete-button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.onclick = function(e) {
                            e.stopPropagation();
                            confirmAction('delete', task.id);
                        };

                        // Complete button (only if task is not complete)
                        if (!task.is_complete) {
                            const completeButton = document.createElement('button');
                            completeButton.classList.add('task-complete-button');
                            completeButton.textContent = 'Complete';
                            completeButton.onclick = function(e) {
                                e.stopPropagation();
                                confirmAction('complete', task.id);
                            };
                            taskButtons.appendChild(completeButton);
                        }

                        taskButtons.appendChild(deleteButton);

                        // Append elements to task block
                        taskBlock.appendChild(taskName);
                        taskBlock.appendChild(taskDescription);
                        taskBlock.appendChild(taskButtons);

                        // Hover effects for description and buttons
                        taskBlock.addEventListener('mouseover', function() {
                            taskDescription.style.display = 'block';
                            taskButtons.style.display = 'flex';
                        });
                        taskBlock.addEventListener('mouseout', function() {
                            taskDescription.style.display = 'none';
                            taskButtons.style.display = 'none';
                        });

                        taskBlock.onclick = function() {
                            openTaskModal(task.id);
                        };

                        taskContainer.appendChild(taskBlock);
                    });
                })
                .catch(error => console.error('Error:', error));
            }

            // Attach click event to folder links
            document.querySelectorAll('.folder-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const folderId = this.dataset.folderId;
                    openFolder(folderId);
                });
            });

            // Edit Folder Name
            window.editFolder = function(folderId, currentName) {
                const newName = prompt('Edit folder name:', currentName);
                if (newName && newName !== currentName) {
                    fetch('{{ url_for('main.edit_folder') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ folder_id: folderId, folder_name: newName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.querySelector(`.folder-link[data-folder-id='${folderId}']`).textContent = newName;
                    })
                    .catch(error => console.error('Error:', error));
                }
            };

            // Open Task Modal for Create/Edit
            function openTaskModal(taskId) {
                currentTaskId = taskId;

                // Fetch and populate collaborators
                loadCollaborators(taskId);

                // Fetch and display friends list for invitation
                loadFriendsForInvitation(taskId);

                // Fetch user's folders and populate the dropdown
                fetch('{{ url_for('main.get_user_folders') }}')
                .then(response => response.json())
                .then(data => {
                    const folderSelect = document.getElementById('task-folder-id');
                    folderSelect.innerHTML = ''; // Clear existing options
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        folderSelect.appendChild(option);
                    });

                    if (currentFolderId) {
                        folderSelect.value = currentFolderId;
                    }

                    if (taskId) {
                        // Fetch task data and populate form
                        fetch(`{{ url_for('main.get_task') }}?task_id=${taskId}`)
                        .then(response => response.json())
                        .then(taskData => {
                            document.getElementById('task-id').value = taskData.task_id;
                            document.getElementById('task-name').value = taskData.task_name;
                            document.getElementById('task-deadline').value = taskData.deadline;
                            document.getElementById('task-description').value = taskData.description;
                            document.getElementById('task-color').value = taskData.color;
                            loadCollaborators(taskId);
                            loadComments(taskId);
                            // Set the selected folder
                            folderSelect.value = taskData.folder_id;
                        })
                        .catch(error => console.error('Error:', error));
                    } else {
                        // Clear form for new task
                        taskForm.reset();
                        document.getElementById('collaborators-list').innerHTML = '';
                        document.getElementById('comments-container').innerHTML = '';
                    }
                    taskModal.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
            }

            // Close Modals
            document.getElementById('close-task-modal').onclick = function() {
                taskModal.style.display = 'none';
            };

            document.getElementById('close-confirm-modal').onclick = function() {
                confirmModal.style.display = 'none';
            };

            // Load friends for inviting as collaborators
            function loadFriendsForInvitation(taskId) {
                fetch('/get_friends') // Backend endpoint to fetch friend list
                    .then(response => response.json())
                    .then(data => {
                        const friendsList = document.getElementById('friends-list');
                        friendsList.innerHTML = '';

                        if (data.friends && data.friends.length > 0) {
                            data.friends.forEach(friend => {
                                const listItem = document.createElement('li');

                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'friend-invite-checkbox';
                                checkbox.value = friend.id;

                                const label = document.createElement('label');
                                label.textContent = friend.name;

                                listItem.appendChild(checkbox);
                                listItem.appendChild(label);
                                friendsList.appendChild(listItem);
                            });

                            const inviteButton = document.createElement('button');
                            inviteButton.textContent = 'Invite Selected Friends';
                            inviteButton.onclick = () => {
                                const selectedFriends = Array.from(
                                    document.querySelectorAll('.friend-invite-checkbox:checked')
                                ).map(cb => cb.value);

                                if (selectedFriends.length === 0) {
                                    alert('No friends selected.');
                                    return;
                                }

                                fetch('/invite_friends_to_task', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token() }}'
                                    },
                                    body: JSON.stringify({ task_id: taskId, friend_ids: selectedFriends })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.message) {
                                            alert(data.message);
                                            loadCollaborators(taskId); // Refresh collaborators list
                                        } else if (data.error) {
                                            alert(data.error);
                                        }
                                    })
                                    .catch(error => console.error('Error inviting friends:', error));
                            };

                            friendsList.appendChild(inviteButton);
                        } else {
                            friendsList.innerHTML = '<li>No friends available to invite.</li>';
                        }
                    })
                    .catch(error => console.error('Error fetching friends:', error));
            }

            // Handle Task Form Submission
            taskForm.onsubmit = function (e) {
                e.preventDefault();
                const formData = new FormData(taskForm);
                const url = currentTaskId ? '{{ url_for('main.edit_task') }}' : '{{ url_for('main.create_task') }}';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(data.message); // Optional: Display success message
                        } else if (data.error) {
                            alert(data.error);
                            return; // Stop further execution if there's an error
                        }

                        taskModal.style.display = 'none'; // Close the modal after success

                        // Refresh tasks in the dashboard
                        if (currentFolderId) {
                            openFolder(currentFolderId); // Refresh tasks in the current folder
                        } else {
                            reloadTasks(); // Refresh all tasks in the dashboard if not in a folder
                        }
                    })
                    .catch(error => console.error('Error creating or editing task:', error));
            };

            // Confirm Delete or Complete Action
            function confirmAction(type, taskId) {
                actionType = type;
                currentTaskId = taskId;
                const message = type === 'delete' ? 'Are you sure you want to delete this task?' : 'Mark this task as complete?';
                document.getElementById('confirm-message').textContent = message;
                confirmModal.style.display = 'block';
            }

            // Handle Confirmation
            document.getElementById('confirm-yes-button').onclick = function() {
                const url = actionType === 'delete' ? '{{ url_for('main.delete_task') }}' : '{{ url_for('main.mark_complete') }}';
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ task_id: currentTaskId })
                })
                .then(response => response.json())
                .then(data => {
                    confirmModal.style.display = 'none';
                    // Refresh the task list
                    if (currentFolderId) {
                        openFolder(currentFolderId);
                    }
                })
                .catch(error => console.error('Error:', error));
            };

            document.getElementById('confirm-no-button').onclick = function() {
                confirmModal.style.display = 'none';
            };

            // Invite User Functionality
            document.getElementById('invite-button').onclick = function() {
                const email = document.getElementById('invite-email').value;
                if (email) {
                    fetch('{{ url_for('main.invite_user') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ task_id: currentTaskId, email: email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(data.message);
                            // Update collaborators list
                            loadCollaborators(currentTaskId);
                        } else if (data.error) {
                            alert(data.error);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            };

            // Load Collaborators
            function loadCollaborators(taskId) {
                fetch(`{{ url_for('main.get_task') }}?task_id=${taskId}`)
                .then(response => response.json())
                .then(taskData => {
                    const collaboratorsList = document.getElementById('collaborators-list');
                    collaboratorsList.innerHTML = '';
                    taskData.collaborators.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.textContent = user.email;
                        collaboratorsList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error:', error));
            }

            // Add Comment
            document.getElementById('add-comment-button').onclick = function() {
                const content = document.getElementById('comment-content').value;
                if (content) {
                    fetch('{{ url_for('main.add_comment') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({ task_id: currentTaskId, content: content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            document.getElementById('comment-content').value = '';
                            loadComments(currentTaskId);
                        } else if (data.error) {
                            alert(data.error);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            };

            // Load Comments
            function loadComments(taskId) {
                fetch(`{{ url_for('main.get_comments') }}?task_id=${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const commentsContainer = document.getElementById('comments-container');
                    commentsContainer.innerHTML = '';
                    data.comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.classList.add('comment');
                        commentDiv.innerHTML = `
                            <p><strong>${comment.user_email}</strong> (${comment.timestamp}):</p>
                            <p>${comment.content}</p>
                        `;
                        commentsContainer.appendChild(commentDiv);
                    });
                })
                .catch(error => console.error('Error:', error));
            }

            // Add Friends Modal Functionality
            const addFriendsModal = document.getElementById('add-friends-modal');
            const openAddFriendsButton = document.getElementById('add-friends-btn');
            const closeAddFriendsButton = document.getElementById('close-modal');
            const searchButton = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const searchInput = document.getElementById('friend-search');

            // Open the modal
            openAddFriendsButton.onclick = () => addFriendsModal.style.display = 'block';

            // Close the modal
            closeAddFriendsButton.onclick = () => addFriendsModal.style.display = 'none';

            // Close modal when clicking outside
            window.onclick = (event) => {
                if (event.target === addFriendsModal) {
                    addFriendsModal.style.display = 'none';
                }
            };

            // Fetch suggestions as the user types
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.trim();
                if (!query) {
                    searchResults.innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch(`/search_users?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    searchResults.innerHTML = '';
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(user => {
                            const li = document.createElement('li');
                            li.textContent = user.username;

                            const addButton = document.createElement('button');
                            addButton.textContent = 'Add Friend';
                            addButton.onclick = async () => {
                                try {
                                    const addResponse = await fetch('/add_friend', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': '{{ csrf_token() }}'
                                        },
                                        body: JSON.stringify({ friend_id: user.id })
                                    });
                                    const addData = await addResponse.json();
                                    if (addResponse.ok) {
                                        alert(addData.message || 'Friend added successfully!');
                                        location.reload(); // Refresh to update friends list
                                    } else {
                                        alert(addData.error || 'Error adding friend.');
                                    }
                                } catch (error) {
                                    console.error('Error adding friend:', error);
                                    alert('An error occurred. Please try again.');
                                }
                            };

                            li.appendChild(addButton);
                            searchResults.appendChild(li);
                        });
                    } else {
                        searchResults.innerHTML = '<li>No users found</li>';
                    }
                } catch (error) {
                    console.error('Error fetching user suggestions:', error);
                    searchResults.innerHTML = '<li>Error fetching suggestions</li>';
                }
            });
        });
    </script>
    {% endblock %}
</body>
</html>